<div class="chat-layout">
  <!-- Config Panel (Left) -->
  <app-config-panel
    [collapsed]="configPanelCollapsed()"
    (collapseToggle)="toggleConfigPanel()"
  />

  <div class="chat-container">
    <!-- Provider Selector (always visible for provider/model selection) -->
    <div class="provider-selector-container">
      <app-provider-selector #providerSelector />
      <div class="provider-selector-actions">
        @if (!sessionId()) {
          <button
            mat-raised-button
            color="primary"
            (click)="startNewConversation()"
            [disabled]="isCreatingSession() || !gooseAvailable || !providerSelector?.getSelectedProvider()"
            class="start-conversation-button"
          >
            <mat-icon>play_arrow</mat-icon>
            Start Conversation with Selected Provider/Model
          </button>
          @if (isCreatingSession()) {
            <mat-spinner diameter="20" class="inline-spinner"></mat-spinner>
            <span class="creating-session-text">Creating session...</span>
          }
        } @else {
          <div class="provider-selector-note">
            <mat-icon>info</mat-icon>
            <span>Active session using {{ activeConversationProviderLabel }} / {{ activeConversationModelLabel }}</span>
            <button
              mat-stroked-button
              color="primary"
              (click)="startNewConversation()"
              [disabled]="isCreatingSession()"
              class="change-provider-button"
            >
              Change Provider/Model
            </button>
          </div>
        }
      </div>
    </div>
    
    <!-- Header with session controls -->
    <div class="chat-header">
      <div class="header-content">
        <div class="session-info">
          <mat-icon class="session-icon">psychology</mat-icon>
          <span class="session-text">
            @if (sessionId()) {
              <strong>Active Conversation</strong>
              <span class="session-id">Session: {{ sessionId()?.substring(0, 8) }}...</span>
            } @else {
              <strong>No Active Session</strong>
            }
          </span>
          @if (gooseAvailable) {
            <span class="provider-badge" [class.genai-service]="isGenaiService">
              <mat-icon class="provider-icon">{{ isGenaiService ? 'cloud' : 'smart_toy' }}</mat-icon>
              {{ activeConversationProviderLabel }} Â· {{ activeConversationModelLabel }}
              @if (isGenaiService) {
                <span class="source-badge">GenAI</span>
              }
            </span>
          }
        </div>
        <div class="session-actions">
          <button
            mat-icon-button
            (click)="toggleConfigPanel()"
            [matTooltip]="configPanelCollapsed() ? 'Show config panel' : 'Hide config panel'"
          >
            <mat-icon>{{ configPanelCollapsed() ? 'settings' : 'settings' }}</mat-icon>
          </button>
          <button
            mat-icon-button
            (click)="toggleActivityPanel()"
            [matTooltip]="activityPanelCollapsed() ? 'Show activity panel' : 'Hide activity panel'"
          >
            <mat-icon>{{ activityPanelCollapsed() ? 'visibility' : 'visibility_off' }}</mat-icon>
          </button>
          <button
            mat-icon-button
            (click)="startNewConversation()"
            [disabled]="isCreatingSession() || !gooseAvailable"
            matTooltip="Start new conversation"
            color="primary"
          >
            <mat-icon>add_circle</mat-icon>
          </button>
          <button
            mat-icon-button
            (click)="endConversation()"
            [disabled]="!sessionId() || isStreaming()"
            matTooltip="End current conversation"
            color="warn"
          >
            <mat-icon>stop_circle</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <div class="messages-container" #messagesContainer>
      @if (messages().length === 0) {
        <div class="welcome-message">
          <mat-icon class="welcome-icon">psychology</mat-icon>
          <h2>Goose Agent Chat</h2>
          @if (gooseAvailable) {
            <p class="status-text">Goose v{{ gooseVersion }} is ready</p>
            <p class="provider-info">
              Provider: {{ activeConversationProviderLabel }} | Model: {{ activeConversationModelLabel }}
              @if (isGenaiService) {
                <span class="source-indicator">(via GenAI Service)</span>
              }
            </p>
            @if (sessionId()) {
              <p class="status-text info">Conversation session active - Goose will remember your conversation context</p>
            } @else if (isCreatingSession()) {
              <p class="status-text info">Starting new conversation...</p>
            }
          } @else {
            <p class="status-text error">{{ gooseMessage || 'Goose CLI is not available' }}</p>
          }
        </div>
      }

      @for (message of messages(); track message.timestamp) {
        <div class="message" [class.user-message]="message.role === 'user'"
             [class.assistant-message]="message.role === 'assistant'">
          <mat-card class="message-card" appearance="outlined">
            <mat-card-content>
              <div class="message-header">
                <mat-icon class="message-icon">
                  {{ message.role === 'user' ? 'person' : 'psychology' }}
                </mat-icon>
                <span class="message-role">{{ message.role === 'user' ? 'You' : 'Goose' }}</span>
                @if (message.streaming) {
                  <mat-spinner diameter="16" class="streaming-indicator"></mat-spinner>
                }
              </div>
              <div class="message-content">
                <markdown [data]="message.content"></markdown>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      }
    </div>

    <div class="input-container">
      <mat-form-field appearance="outline" class="message-input">
        <mat-label>Type your message...</mat-label>
        <textarea
          matInput
          [value]="userInput()"
          (input)="onInputChange($event)"
          (keypress)="onKeyPress($event)"
          [disabled]="isStreaming() || !gooseAvailable || !sessionId()"
          rows="3"
          [placeholder]="sessionId() ? 'Ask Goose anything...' : 'Select a provider/model and start a conversation first'"
        ></textarea>
      </mat-form-field>
      <button
        mat-fab
        extended
        color="primary"
        (click)="sendMessage()"
        [disabled]="!userInput().trim() || isStreaming() || !gooseAvailable || !sessionId()"
        class="send-button"
      >
        @if (isStreaming()) {
          <mat-spinner diameter="24"></mat-spinner>
        } @else {
          <mat-icon>send</mat-icon>
        }
        {{ isStreaming() ? 'Sending...' : 'Send' }}
      </button>
    </div>
  </div>

  <!-- Activity Panel -->
  <app-activity-panel
    [activities]="activities()"
    [todos]="todos()"
    [collapsed]="activityPanelCollapsed()"
    (collapseToggle)="toggleActivityPanel()"
  />
</div>
